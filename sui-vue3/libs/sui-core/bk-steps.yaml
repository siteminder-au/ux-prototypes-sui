  - group: 'sui-core'

    steps:

      - label: 'sui-core npm cache'
        key: npm-cache-sui-core
        command: "./node_modules/@siteminder/overlord/shared/ci-scripts/npm-cache.sh libs/sui-core/docker-compose.yaml"
        agents:
          queue: "${BUILDKITE_AGENT_META_DATA_QUEUE}"
        timeout_in_minutes: 30
        soft_fail:
          - exit_status: 2

      - label: 'sui-core audit'
        command: "./node_modules/@siteminder/overlord/shared/ci-scripts/audit.sh libs/sui-core/docker-compose.yaml"
        agents:
          queue: "${BUILDKITE_AGENT_META_DATA_QUEUE}"
        timeout_in_minutes: 30
        soft_fail:
          - exit_status: 3

      - label: 'sui-core lint'
        depends_on:
          - step: npm-cache-sui-core
            allow_failure: true
        command: "./node_modules/@siteminder/overlord/shared/ci-scripts/lint.sh libs/sui-core/docker-compose.yaml"
        agents:
          queue: "${BUILDKITE_AGENT_META_DATA_QUEUE}"
        timeout_in_minutes: 30

      - label: 'sui-core test'
        key: test-sui-core
        depends_on:
          - step: npm-cache-sui-core
            allow_failure: true
        command: "./node_modules/@siteminder/overlord/shared/ci-scripts/test.sh libs/sui-core/docker-compose.yaml"
        agents:
          queue: "${BUILDKITE_AGENT_META_DATA_QUEUE}"
        timeout_in_minutes: 30
        artifact_paths:
          - "libs/sui-core/test/logs/*.log"
          - "libs/sui-core/test/logs/*.tar.gz"
        retry:
          automatic:
          - exit_status: -1 # Agent was lost
            limit: 1
          - exit_status: 1  # Test failure
            limit: 1
          # No other exit codes supported, e.g. exit code 2 is used for non-recoverable errors e.g. compile failures

      # this step is to run type checking on `.vue` files as specified in tsconfig.vue-tsc.json
      # vite does not do any type checking so we use vue-tsc (based on Volar.js) as a dedicated build step
      # we also check the bundlefile size didn't exceed certain expected upper limits specified in package.json file
      - label: 'sui-core extra checks'
        key: extra-checks-sui-core
        command: 'cd libs/sui-core && /workdir/node_modules/\@siteminder/overlord/shared/project/bootstrap.sh && npm run extra-checks'
        plugins:
          - docker#v3.13.0:
              image: "278521702583.dkr.ecr.us-west-2.amazonaws.com/arch/node-v20-builder:v2.0.2"
              volumes:
                - "$HOME/.npmrc:/root/.npmrc"

      - label: 'sui-core npm publish'
        depends_on:
          - "test-sui-core"
          - "extra-checks-sui-core"
        command: "./node_modules/@siteminder/overlord/shared/ci-scripts/smpublish.sh libs/sui-core/docker-compose.yaml"
        agents:
          queue: "${BUILDKITE_AGENT_META_DATA_QUEUE}"
        timeout_in_minutes: 30
